{"layout":"post","title":"How to create an Authentication Provider in Drupal 8","description":"Explanation to create a custom Autentication Provider in Drupal 8","categories":["articles"],"tags":["Drupal","Drupal Modules","Rest"],"draft":false,"body":"<p>Some weeks ago I show you <a href=\"{{site.url }}/articles/2014/12/16/how-to-create-a-rest-resource-in-drupal-8\" target=\"_blank\">How to create a Rest Resource in Drupal 8</a> and as I explain in that post we use the Authentication Provider <strong>Basic Auth</strong> as you can see in the following image.</p>\n<p><img src=\"{{site.url}}/assets/img/restui_bundle_entities_settings.png\"/></p>\n<p>Right now is the unique Authentication Provider available to use in a <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS\" target=\"_blank\">CORS</a> scenery. If you want to read more about CORS you can read the blog entry <a href=\"{{site.url }}2014/05/31/what-is-cross-origin-resource-sharing-cors\" target=\"_blank\">What is Cross-Origin Resource Sharing (CORS)</a>.</p>\n<p>But what about if <strong>Basic Auth</strong> doesn’t fit with your needs, well I will show you how to create a custom Authentication Provider.</p>\n<p>#The Requirement</p>\n<p>My imaginary request will be create an Authentication Provider without user validation, that means access as <strong>Anonymous</strong> user, but we require to validate the source of request to check against an <strong>IP White List</strong> enabled to access our REST resources.</p>\n<p>#Create a Module</p>\n<p>I will skip the explanation about how to create the Module <strong>ip_consumer_auth</strong> in Drupal 8 because could be generated using the project <a href=\"http://drupalconsole.com/\" target=\"_blank\">Drupal Console</a> executing the following command.</p>\n<pre><code>$ drupal generate:module\n</code></pre><p>After create the module with the console, we will use the console again to create a Form Configuration to create our <strong>IP White List</strong> using the following command.</p>\n<pre><code>$ drupal generate:form:config\n</code></pre><p>Now we must add a Textarea field to the form to store allowed IP Address. The implementation of method buildForm will looks similar to following snippet.</p>\n<pre><code>/**\n * {@inheritdoc}\n */\npublic function buildForm(array $form, FormStateInterface $form_state) {\n  $config = $this-&gt;config(&#39;ip_consumer_auth.consumers_form_config&#39;);\n  $form[&#39;allowed_ip_consumers&#39;] = [\n    &#39;#type&#39; =&gt; &#39;textarea&#39;,\n    &#39;#title&#39; =&gt; $this-&gt;t(&#39;Allowed IP Consumers&#39;),\n    &#39;#description&#39; =&gt; $this-&gt;t(&#39;Place IP addresses on separate lines&#39;),\n    &#39;#default_value&#39; =&gt; $config-&gt;get(&#39;allowed_ip_consumers&#39;),\n  ];\n  return parent::buildForm($form, $form_state);\n}\n</code></pre><p>The form class will be located at <strong>ip_consumer_auth/src/Form/ConsumersForm.php</strong></p>\n<p>The layout to enter allowed IP consumer will looks similar to this image</p>\n<p><img src=\"{{site.url}}/assets/img/allowed_ip_resources.png\"/></p>\n<p>The code to save that values are generated by <strong>Drupal Console</strong>, in the same way the Routing is created. Be sure you change the values to your convenience after generate the form.</p>\n<p>#Create Authentication Provider</p>\n<p>Before to start with code for our Authetication Provider we need to inform to <strong>Drupal 8</strong> the existence of our custom Authentication Provider, to do that we add a new file in our module named <strong>ip_consumer_auth.service.yml</strong> because my module name is <strong>ip_consumer_auth</strong>.</p>\n<p>Let me show you the content of that file</p>\n<pre><code>services:\n  authentication.ip_consumer_auth:\n    class: Drupal\\ip_consumer_auth\\Authentication\\Provider\\IPConsumerAuth\n    arguments: [&#39;@config.factory&#39;, &#39;@entity.manager&#39;]\n    tags:\n      - { name: authentication_provider, priority: 100 }\n</code></pre><p>The discover for services will find this file and registering our Authentication Provider Class <strong>Drupal\\ip_consumer_auth\\Authentication\\Provider\\IPConsumerAuth</strong> and prepare the elements to send to constructor.</p>\n<p>With the sentence above we don’t have to implement the method <strong>create</strong> in our class, because the Discover send the parameters using <a href=\"http://en.wikipedia.org/wiki/Dependency_injection\" target=\"_blank\">Dependency Injection</a>.</p>\n<p>At the end we define the priority, this value will define the execution order if multiple Authentication Provider were enabled.</p>\n<p>##Implement Class Authentication Provider IPConsumerAuth</p>\n<p>Our class <strong>IPConsumerAuth</strong> must implement the interface <a href=\"https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Authentication!AuthenticationProviderInterface.php/interface/AuthenticationProviderInterface/8\" target=\"_blank\">AuthenticationProviderInterface</a> as you can see in the following snippet.</p>\n<pre><code>/**\n * IP Consumer authentication provider.\n */\nclass IPConsumerAuth implements AuthenticationProviderInterface {\n}\n</code></pre><p>##Libraries\nThe Authentication Provider require some libraries and we must to inform to AutoLoader where are these libraries, let me show the complete list.</p>\n<pre><code>namespace Drupal\\ip_consumer_auth\\Authentication\\Provider;\n\nuse \\Drupal\\Component\\Utility\\String;\nuse Drupal\\Core\\Authentication\\AuthenticationProviderInterface;\nuse Drupal\\Core\\Config\\ConfigFactoryInterface;\nuse Drupal\\Core\\Entity\\EntityManagerInterface;\nuse Drupal\\Core\\Flood\\FloodInterface;\nuse Drupal\\user\\UserAuthInterface;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpKernel\\Event\\GetResponseForExceptionEvent;\nuse Symfony\\Component\\HttpKernel\\Exception\\UnauthorizedHttpException;\nuse Symfony\\Component\\HttpKernel\\Exception\\AccessDeniedHttpException;\n</code></pre><p>##Implement method applies\nEven if the Authentication Provider is enabled for some REST resource is required a validation to confirm the Authentication Provider apply for current Request.</p>\n<p>In our case if our Authentication Provider was enabled we will add any extra validation as you can see in the following implementation.</p>\n<pre><code>/**\n * {@inheritdoc}\n */\npublic function applies(Request $request) {\n  // If Authentication Provider is enabled always apply\n  return TRUE;\n}\n</code></pre><p>##Implement method authenticate\nNow we have to implement the logic to execute to validate the Request, check the following snippet.</p>\n<pre><code>/**\n * {@inheritdoc}\n */\npublic function authenticate(Request $request) {\n  $allowed_ip_consumers = $this-&gt;configFactory-&gt;get(&#39;ip_consumer_auth.consumers_form_config&#39;)-&gt;get(&#39;allowed_ip_consumers&#39;);\n  $ips = array_map(&#39;trim&#39;, explode( &quot;\\n&quot;, $allowed_ip_consumers));\n  $consumer_ip = $request-&gt;getClientIp(TRUE);\n  if (in_array($consumer_ip, $ips)) {\n    // Return Anonymous user\n    return $this-&gt;entityManager-&gt;getStorage(&#39;user&#39;)-&gt;load(0);\n  }\n  else{\n    throw new AccessDeniedHttpException();\n    return null;\n  }\n}\n</code></pre><p>In the implementation above I use the <strong>configFactory</strong> to get the information stored about allowed IP Consumer using the Settings form created before.</p>\n<p>The authenticate method receive an <a href=\"http://api.symfony.com/2.0/Symfony/Component/HttpFoundation/Request.html\" target=\"_blank\">Request</a> object defined in <a href=\"http://symfony.com/doc/current/components/http_foundation/introduction.html\"></a>The HttpFoundation Component</a> of <a href=\"http://symfony.com/\" target=\"_blank\">Symfony</a>.</p>\n<p>Using the Request method <a href=\"http://api.symfony.com/2.0/Symfony/Component/HttpFoundation/Request.html#method_getClientIp\" target=\"_blank\">getClientIp</a> we get the IP of Consumer.</p>\n<p>I used the PHP functions <a href=\"http://php.net/manual/es/function.explode.php\" target=\"_blank\">explode</a>, <a href=\"http://php.net/manual/es/function.array-map.php\" target=\"_blank\">array_map</a> and <a href=\"http://php.net/manual/en/function.in-array.php\" target=\"_blank\">in_array</a> to determine if IP consumer belong to Allowed IP consumer. I know maybe with a regex will be more efficient but I really sucks in Regex.</p>\n<p>If validation pass I return an Account object for Anonymous user, if fail an Access Denied Exception is throw.</p>\n<p>##Implement method handleException\nIf the IP wasn’t in the allowed list of IP Consumer an exception is throw, using the method <strong>handleException</strong> we have the option to intercept and process to produce any output desired.</p>\n<p>Let me share with you my implementation</p>\n<pre><code>  /**\n   * {@inheritdoc}\n   */\n  public function cleanup(Request $request) {}\n\n  /**\n   * {@inheritdoc}\n   */\n  public function handleException(GetResponseForExceptionEvent $event) {\n    $exception = $event-&gt;getException();\n    if ($exception instanceof AccessDeniedHttpException) {\n      $event-&gt;setException(new UnauthorizedHttpException(&#39;Invalid consumer origin.&#39;, $exception));\n      return TRUE;\n    }\n    return FALSE;\n  }\n</code></pre><p>As you can see is not to complex, but is just an idea above what you can do with this method.</p>\n<p>#Usage</p>\n<p>After create our module with our custom Authentication Provider and enable it, we are ready to start to use.</p>\n<p>Lets imagine you install the module <a href=\"https://github.com/enzolutions/entity_rest_extra\" target=\"_blank\">Entity Rest Extra</a> and we will use our Authentication Provider.</p>\n<p>Using the <a href=\"https://www.drupal.org/project/restui/git-instructions\" target=\"_blank\">Rest UI</a>(I recommend to use the git version until Drupal 8 get a first release) module we enable the REST Resource and enable our Custom Authentication Provider, as you can see in the following image.</p>\n<p><img src=\"{{site.url}}/assets/img/custom_authentication_provider.png\"/></p>\n<p>##Access Denied\nNow if you try to access via CORS the REST end point <strong><a href=\"http://example.com/bundles/node\">http://example.com/bundles/node</a></strong> you will get an error <strong>403 Forbidden</strong> because the allowed IP consumers weren’t defined yet.</p>\n<p>##Unauthorized\nAfter enable your IP consumer and try again <strong><a href=\"http://example.com/bundles/node\">http://example.com/bundles/node</a></strong> you will get an error <strong>401 Unauthorized</strong></p>\n<p>If that error doesn’t have any logic for you let me explain, remember in our Authentication Provider we don’t have information about any user, so if the request pass the validation of IP Consumer we return an Anonymous user.</p>\n<p>When we enable any REST Resource in Drupal 8 a new set of  permissions is created, in our case we have to assign the permission <strong>Access GET on Bundles by entities resource</strong> to Anonymous user as you can see in the following image.</p>\n<p><img src=\"{{site.url}}/assets/img/rest_anonymous_permission.png\"/></p>\n<p>##Access Denied AGAIN\nWell maybe at this point you get MAD with me, because now you get again an error\n <strong>403 Forbidden</strong>, but at this time the fault is not caused by Authentication Provider or by Rest permission itself.</p>\n<p> The error now is related with REST Resource itself is you check the code of module <strong>Entity Rest Extra</strong> you will found the permission <strong>Administer content types</strong> is required to access this Resource.</p>\n<p>##Bonus\n Well you can complain about nobody inform to you that module has own permissions validation or the REST permissions, well that could be true.</p>\n<p> If you want to get more information about a specific Drupal 8 router you can use the <strong>Drupal Console</strong>.</p>\n<p> First thing you have to do is determine the Router id, we can you the canonical URL of REST resource as you can see in the following command.</p>\n <pre>\n $ console router:debug | grep bundles/{entity}\n rest.entity_bundles.GET.json                             /bundles/{entity}\n </pre>\n\n<p> Now we can get more information about router using the following command.</p>\n <pre>\n $ console router:debug rest.entity_bundles.GET.json\n Route name                   Options\n rest.entity_bundles.GET.json\n  + Pattern                   /bundles/{entity}\n  + Defaults\n   - _controller              Drupal\\rest\\RequestHandler::handle\n   - _plugin                  entity_bundles\n  + Options\n   - compiler_class           \\Drupal\\Core\\Routing\\RouteCompiler\n   - _access_mode             ANY\n   - 0                        ip_consumer_auth\n   - 0                        access_check.permission\n  </pre>\n\n<p> As you can see the last thing executed is access_check.permission generating the error 401. Maybe in the future the internal permissions in resourced will be included.</p>\n<p> If you want see a complete implementation of Authentication provider you clone the project <a href=\"https://github.com/enzolutions/ip_consumer_auth\" target=\"_blank\">IP Consumer Auth</a></p>\n<p> I hope you found this blog entry useful.</p>\n","updatedAt":"2017-09-05T17:40:56.000Z"}
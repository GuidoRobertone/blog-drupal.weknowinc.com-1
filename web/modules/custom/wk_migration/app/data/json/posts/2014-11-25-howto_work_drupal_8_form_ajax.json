{"layout":"post","title":"How to work with Drupal 8 forms with Ajax.","description":"How to add Ajax effect to a Form in Drupal 8","categories":["articles"],"tags":["Drupal","Ajax","Drupal8"],"draft":false,"body":"<p>Nowadays Drupal 8 has couple of beta releases so the official release is around the corner. For that reason I start to test the typical features required in a Drupal 7 site.</p>\n<p>Today I will share with you my experiences with Form with Ajax effects.</p>\n<p>#Create a Form</p>\n<p>I will skip the explanation about how to create a Form in Drupal 8 because could be generated using the project <a href=\"http://drupalconsole.com/\" target=\"_blank\">Drupal Console</a> executing the following command.</p>\n<pre><code>$ php console.phar generate:form:config\n</code></pre><p>#Drupal 8 FAPI + Ajax</p>\n<p>The current documentation of FAPI for Drupal 8 about <a href=\"https://api.drupal.org/api/drupal/developer!topics!forms_api_reference.html/8#ajax\" target=\"_blank\">ajax</a> is not updated.</p>\n<p>But the property is still name <strong>#ajax</strong> check the following implementation.</p>\n<pre><code>   $form[&#39;source&#39;][&#39;version&#39;] = array(\n      &#39;#type&#39; =&gt; &#39;radios&#39;,\n      &#39;#title&#39; =&gt; $this-&gt;t(&#39;Drupal Version&#39;),\n      &#39;#default_value&#39;=&gt;&quot;d6&quot;,\n      &#39;#options&#39; =&gt; $options,\n      &#39;#description&#39; =&gt; t(&#39;Choise what version of Drupal you want migrate&#39;),\n      &#39;#required&#39; =&gt; TRUE,\n      &#39;#ajax&#39; =&gt; array(\n        &#39;callback&#39; =&gt; &#39;::updateDestinationIds&#39;,\n        &#39;wrapper&#39; =&gt; &#39;edit-destinations&#39;,\n        &#39;progress&#39; =&gt; array(\n          &#39;type&#39; =&gt; &#39;throbber&#39;,\n          &#39;message&#39; =&gt; &quot;searching&quot;,\n        ),\n      ),\n    );\n</code></pre><p>If you are a old developer of Drupal you will recognize the properties <strong>wrapper</strong>, <strong>progress</strong>, these properties work equal in Drupal 7.</p>\n<p>The main change is in callback property, in my example the value ‘::updateDestinationIds’ means the method <em>updateDestinationIds</em> is part of the Form class. I didn’t test but looks like we can assign a static method like ‘Drupal::StaticMethod’.</p>\n<p>#Response method</p>\n<p>Similar to Drupal 7 the method has to return the portion of the Form must be overwritten via ajax, let me show you an example.</p>\n<pre><code>/**\n * Gets migration configurations.\n *\n * @return array\n *   An array of migration names.\n */\nfunction updateDestinationIds($form, FormStateInterface $form_state) {\n    $form [&#39;source&#39;][&#39;migration_ids&#39;][&#39;#options&#39;] = $this-&gt;getDestinationIds($form_state-&gt;getValue(&#39;version&#39;));\n    return $form [&#39;source&#39;][&#39;migration_ids&#39;];\n}\n</code></pre><p>#Known Issues</p>\n<p>After implement the Ajax function I detect a problem when I try to select values populated via Ajax and submit the form I get this error message “An illegal choice has been detected. Please contact the site administrator.”</p>\n<p>When I debug I can determine the method <a href=\"https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Installer!Form!SiteSettingsForm.php/function/SiteSettingsForm%3A%3AbuildForm/8\" target=\"_blank\">buildForm</a> is executed in different moments listed below</p>\n<ul>\n<li><strong>Form load</strong>: To build the form</li>\n<li><strong>Ajax request</strong>: To re-build the form and determine elements to overwrite.</li>\n<li><strong>Form submit</strong>: To process the form</li>\n</ul>\n<p>My problem was in the last one <em>Form Submit</em> because the submit run the implementation of class <a href=\"https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Form%21FormValidator.php/8\" target=\"_blank\">FormValidator</a>.</p>\n<p>The FormValidator ignore the Ajax process and validate the FormState values against the list of values allowed and because took this values from buildForm they are always the initial values ignoring the user interaction.</p>\n<p>To resolve this problem I use the  <a href=\"https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Form%21FormState.php/class/FormState/8\" target=\"_blank\">FormState</a> object to determine if buildForm was executed to render the form at first time or if has human interaction (ajax or submit) to define the allowed list of values based in user interaction, check the following snippet.</p>\n<pre><code>$form_state_complete_form=$form_state-&gt;getCompleteForm();\nif(empty($form_state_complete_version)){\n    $form [&#39;source&#39;][&#39;migration_ids&#39;][&#39;#options&#39;] = $this-&gt;getDestinationIds(&quot;d6&quot;);\n }\n  else  {\n   $form [&#39;source&#39;][&#39;migration_ids&#39;][&#39;#options&#39;] = $this-&gt;getDestinationIds($form_state_complete_version);\n }\n</code></pre><p>Don’t be worry about this behavior as you can see is easy to fix and I’m sure won’t be necessary when Drupal 8 get the first official release.</p>\n<p>#Caveats</p>\n<p>The current status of Drupal 8 only support the ajax update in <em>Select</em> elements, I tried with <strong>tableselect</strong> and <strong>checkboxes</strong> and doesn’t work.</p>\n<p>There is an issue for this problem at <a href=\"https://www.drupal.org/node/1458824\" target=\"_blank\">Ajax doesn’t work with Tableselect with checkboxes</a>.</p>\n","updatedAt":"2017-09-05T17:40:56.000Z"}
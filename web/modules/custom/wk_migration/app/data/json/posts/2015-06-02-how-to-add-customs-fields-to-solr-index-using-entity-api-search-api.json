{"layout":"post","title":"How to add customs fields to SOLR index using Entity API &amp; Search API","categories":["articles"],"tags":["Drupal","Entity API","Search API","SOLR"],"body":"<p>Nowadays the ability to search in website almost compulsory and most of the times is took for granted.</p>\n<p>Using Drupal we have two main options <a href=\"http://lucene.apache.org/solr/\">SOLR</a> and <a href=\"https://www.elastic.co/\">Elastic Search</a>. \nToday I will explore how to work SOLR server.</p>\n<p>In Drupal there are two popular modules to connect it with <strong>SOLR</strong> <a href=\"https://www.drupal.org/project/apachesolr\">apachesolr</a> and \n <a href=\"https://www.drupal.org/project/search_api\">search_api</a> and I decided to use <strong>search_api</strong> to interact with SOLR in \nthis article.</p>\n<p>#The problem</p>\n<p>Lets imagine this problem: We have an Event content type with a Date field to determine the start date and end date (optional).</p>\n<p>Using Search API that field could be indexed without mayor problems, but if we try to do a view to list all event in a date range\n is difficult because Views modules doesn’t provide the Between operator for SOLR views, this operator is only available\n for views using <strong>Entity Fields</strong></p>\n<p>#The Solution</p>\n<p>Because all events have minute granularity we can’t use <strong>equal</strong> operator to determine if an event belongs to a specific day, to \nsolve that problem we add extra information to SOLR creating two new fields to store the day event in timestamp in order to be \nable to use the equal operator.</p>\n<p>To create these new fields in our node entities we will use <a href=\"http://drupal.org/project/entity\">Entity API</a> and more specifically \nhook <a href=\"http://www.drupalcontrib.org/api/drupal/contributions!entity!entity.api.php/function/hook_entity_property_info_alter/7\">hook_entity_property_info_alter</a>.</p>\n<p>Let me show you an implementation example.</p>\n<pre><code>/**\n * Implements hook_entity_property_info_alter().\n */\nfunction MYMODULE_entity_property_info_alter(&amp;$info) {\n  $info[&#39;node&#39;][&#39;properties&#39;][&#39;event_start_day&#39;] = array(\n    &#39;type&#39; =&gt; &#39;integer&#39;,\n    &#39;label&#39; =&gt; t(&#39;Event Start Day&#39;),\n    &#39;sanitized&#39; =&gt; TRUE,\n    &#39;getter callback&#39; =&gt; &#39;MYMODULE_search_api_property_event_start_day_getter_callback&#39;,\n  );\n  $info[&#39;node&#39;][&#39;properties&#39;][&#39;event_end_day&#39;] = array(\n    &#39;type&#39; =&gt; &#39;integer&#39;,\n    &#39;label&#39; =&gt; t(&#39;Event End Day&#39;),\n    &#39;sanitized&#39; =&gt; TRUE,\n    &#39;getter callback&#39; =&gt; &#39;MYMODULE_search_search_api_property_event_end_day_getter_callback&#39;,\n  );\n}\n</code></pre><p>As you can see we are modifying entity definition to include two new properties <strong>event_start_day</strong> and <strong>event_end_day</strong>,\nprobably the most information is the <strong>getter callback</strong> which is a function used to calculate the proper values for each \nproperty. </p>\n<p>The functions defined in getter callback is used by Search API in the process of indexing to store the value in SOLR index.</p>\n<p>Let me show an example of implementation of those getter functions.</p>\n<pre><code>/**\n * Getter callback for event start day.\n */\nfunction MYMODULE_search_api_property_event_start_day_getter_callback($item) {\n  return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0][&#39;value&#39;], 0, 10)); \n}\n\n/**\n * Getter callback for event end day.\n */\nfunction MYMODULE_search_search_api_property_event_end_day_getter_callback($item) {\n  // Set time at midnight of end day of event\n  if($item-&gt;field_event_date[LANGUAGE_NONE][0][&#39;value2&#39;] != &#39;&#39;) {\n    return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0][&#39;value2&#39;], 0, 10)) + 86399;\n  }\n  else {\n    return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0][&#39;value&#39;], 0, 10)) + 86399;\n  }\n}\n</code></pre><p>Off course you can implement any logic required here, the variable $item is an object representing a Drupal node.</p>\n<p>After clear your cache the new fields will be able to select to be indexed by SOLR, you can do this accessing the URL \n<strong><a href=\"http://example.com/admin/config/search/search_api/index/YOUR_INDEX/fields\">http://example.com/admin/config/search/search_api/index/YOUR_INDEX/fields</a></strong> as you can see in the following \nimage.</p>\n<p><img style=\"float:left; margin-right: 20px;\" src=\"{{site.url }}/assets/img/entity_fields_solr_index_search_api.png\"/></p>\n<p>When the process of re-index run again the new fields will be stored in SOLR and will be able to be selected in a View.</p>\n<p>I hope you found this post useful. </p>\n","updatedAt":"2017-09-05T17:40:56.000Z"}